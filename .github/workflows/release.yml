name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配 v1.0.0, v1.2.3 等格式的tag

jobs:
  build-and-release:
    runs-on: windows-latest  # 使用Windows环境，因为你的项目是打包成exe
    timeout-minutes: 30  # 增加超时时间到30分钟

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # 使用更稳定的3.11版本

    - name: Verify Python setup
      run: |
        python --version
        python -c "import sys; print('Python executable:', sys.executable)"
        python -c "import platform; print('Platform:', platform.platform())"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 先尝试安装基础依赖
        pip install --timeout 300 --retries 5 python-dotenv pillow
        # 然后安装agentscope（这个包可能有问题）
        pip install --timeout 300 --retries 5 agentscope
        # 安装可能有问题的包
        pip install --timeout 300 --retries 5 PyMuPDF opencv-python
        # 最后安装pyinstaller
        pip install --timeout 300 --retries 5 pyinstaller
      timeout-minutes: 15

    - name: Test imports
      run: |
        python -c "import sys; print('Testing imports...')"
        python -c "import dotenv; print('dotenv OK')"
        python -c "import PIL; print('PIL OK')"
        python -c "import fitz; print('PyMuPDF OK')"
        python -c "import cv2; print('opencv OK')"
        python -c "import agentscope; print('agentscope OK')"
        echo "All imports successful"

    - name: Build executable
      run: |
        # 先检查spec文件是否存在
        dir xxzhou.spec
        # 简化构建命令
        pyinstaller --clean xxzhou.spec
      timeout-minutes: 20

    - name: Verify build output
      run: |
        # 检查构建结果
        dir dist\
        if exist dist\xxzhou.exe (
          echo "Build successful - exe file exists"
        ) else (
          echo "Build failed - exe file not found"
          exit 1
        )

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        # 从tag中提取版本号（去掉v前缀）
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Release ${{ steps.get_version.outputs.tag }}
        body: |
          ## 自动发布版本 ${{ steps.get_version.outputs.tag }}

          ### 更新内容
          - 请查看提交历史了解详细更新内容

          ### 安装说明
          1. 下载 `xxzhou.exe` 文件
          2. 将exe文件放置在合适位置
          3. 配置环境变量或直接运行

          ### 系统要求
          - Windows 操作系统
          - Python 3.13+ (如果需要源码运行)

          ### 功能特性
          - PDF文档智能识别
          - 图片内容识别和处理
          - 视频下载功能
          - 智能对话助手
        draft: false
        prerelease: false
        files: ./dist/xxzhou.exe
